# MCU class and specific type
MCU STM32H7xx STM32H743xx

# USB setup
USB_VENDOR 0x26ac
USB_PRODUCT 0x1167
USB_STRING_MANUFACTURER "3DR"
USB_STRING_PRODUCT "QZP"

# crystal frequency
OSCILLATOR_HZ 24000000
define STM32_HSE_BYPASS
define SMPS_EXT

# TODO: A new ID needs to be requested
# board ID for firmware load
APJ_BOARD_ID 1167

FLASH_SIZE_KB 2048

# with 2M flash we can afford to optimize for speed
env OPTIMIZE -O2

# start on 2th sector (1st sector for bootloader)
FLASH_RESERVE_START_KB 128

define HAL_STORAGE_SIZE 32768

PA8 RCC_MCO_1 OUTPUT LOW

# Enable sensors
PE4 VDD_SENSORS_EN OUTPUT HIGH
PE12 VDD_PLU_EN OUTPUT HIGH

# RC Input set for interrupt not DMA
PC6 TIM3_CH1 TIM3 RCININT PULLDOWN LOW

# Order of I2C buses
I2C_ORDER I2C1 I2C2 I2C4

# this board has no internal I2C buses so mark them all external
define HAL_I2C_INTERNAL_MASK 0

# order of UARTs and suggested uses
# USART2 TELEM1
# USART3 TELEM2
# UART4 GPS
# UART7 TELEM3
# UART8 PLU

# OTG1 and OTG2 are USB devices (1x physical USB connection enumerated as 2x logical ports)

# order of UARTs (and USB) 
SERIAL_ORDER OTG1 USART2 USART3 UART4 UART7 UART8 OTG2

# USART2 (telem1)
PD5 USART2_TX USART2
PD6 USART2_RX USART2
PD3 USART2_CTS USART2
PD4 USART2_RTS USART2

# USART3 (telem2)
PD8 USART3_TX USART3
PD9 USART3_RX USART3
PD11 USART3_CTS USART3
PD12 USART3_RTS USART3

# UART4 (gps)
PD1 UART4_TX UART4
PD0 UART4_RX UART4

# UART7 (telem3)
PE8 UART7_TX UART7
PE7 UART7_RX UART7

# UART8 (plu)
PE1 UART8_TX UART8
PE0 UART8_RX UART8
PD14 UART8_CTS UART8
PD15 UART8_RTS UART8

# TODO: RSSI Analog Input
# PXX RSSI_IN ADCX

# Now the VDD sense pin. This is used to sense primary board voltage.
PA4 VDD_5V_SENS ADC1 SCALE(2)

# SPI1 BMI088
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1

# SPI2 IIM-42652
PB13 SPI2_SCK SPI2
PB14 SPI2_MISO SPI2
PB15 SPI2_MOSI SPI2

# SPI4 DPS368
PE2 SPI4_SCK SPI4
PE5 SPI4_MISO SPI4
PE6 SPI4_MOSI SPI4

# SPI6 FRAM
PB3 SPI6_SCK SPI6
PB4 SPI6_MISO SPI6
PB5 SPI6_MOSI SPI6

# This is the pin that senses USB being connected. It is an input pin
# setup as OPENDRAIN.
PA9 VBUS INPUT OPENDRAIN

# This input pin is used to detect that power is valid on USB.
PC0 VBUS_VALID INPUT PULLDOWN

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# PWM output for buzzer
PC7 TIM3_CH2 TIM3 GPIO(77) ALARM

# First I2C bus.
PB6 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1

# Second I2C bus.
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# Third I2C bus.
PB8 I2C4_SCL I2C4
PB9 I2C4_SDA I2C4

# microSD card
PC8 SDMMC1_D0 SDMMC1
PC9 SDMMC1_D1 SDMMC1
PC10 SDMMC1_D2 SDMMC1
PC11 SDMMC1_D3 SDMMC1
PC12 SDMMC1_CK SDMMC1
PD2 SDMMC1_CMD SDMMC1

# CS pins for SPI sensors. The labels for all CS pins need to
# match the SPI device table later in this file.
PA15 FRAM_CS CS SPEED_VERYLOW NODMA 
PB12 IIM42652_CS CS 
PE3 BARO_CS CS 
PB0 BMI088_GYRO_CS CS 
PC5 BMI088_ACCEL_CS CS

# Now we start defining some PWM pins. We also map these pins to GPIO
# values, so users can set BRD_PWM_COUNT to choose how many of the PWM
# outputs on the primary MCU are setup as PWM and how many as
# GPIOs. To match HAL_PX4 we number the GPIOs for the PWM outputs
# starting at 50.

PE9 TIM1_CH1 TIM1 PWM(1) GPIO(50)
PE11 TIM1_CH2 TIM1 PWM(2) GPIO(51)
PE13 TIM1_CH3 TIM1 PWM(3) GPIO(52)
PE14 TIM1_CH4 TIM1 PWM(4) GPIO(53)
PA0 TIM2_CH1 TIM2 PWM(5) GPIO(54)
PA1 TIM2_CH2 TIM2 PWM(6) GPIO(55)
PA2 TIM2_CH3 TIM2 PWM(7) GPIO(56)
PA3 TIM2_CH4 TIM2 PWM(8) GPIO(57)

# Only available as test points
PD13 TIM4_CH2 TIM4 PWM(9) GPIO(58)

# This is the invensense iim42652 data-ready pin.
PD10 MPU_DRDY INPUT

# Power flag pins: these tell the MCU the status of the various power
# supplies that are available. The pin names need to exactly match the
# names used in AnalogIn.cpp. 
PC1 VDD_BRICK_VALID INPUT PULLDOWN

# SPI Table
SPIDEV bmi088_g    SPI1 DEVID1  BMI088_GYRO_CS    MODE3  10*MHZ  10*MHZ
SPIDEV bmi088_a    SPI1 DEVID2  BMI088_ACCEL_CS   MODE3  10*MHZ  10*MHZ
SPIDEV iim42652    SPI2 DEVID3  IIM42652_CS       MODE3  10*MHZ  10*MHZ
SPIDEV dps310      SPI4 DEVID4  BARO_CS           MODE3  5*MHZ  5*MHZ
SPIDEV ramtron     SPI6 DEVID10 FRAM_CS           MODE3  8*MHZ  8*MHZ

# Enable RAMTROM parameter storage.
define HAL_STORAGE_SIZE 32768
define HAL_WITH_RAMTRON 1

# Enable FAT filesystem support (needs a microSD defined via SDMMC).
define HAL_OS_FATFS_IO 1

# COMPASS
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
COMPASS IST8310 I2C:ALL_INTERNAL:0x0E false ROTATION_NONE

# IMUs
IMU Invensensev3 SPI:iim42652               ROTATION_NONE
IMU BMI088       SPI:bmi088_a SPI:bmi088_g ROTATION_NONE

define HAL_DEFAULT_INS_FAST_SAMPLE 7

# BARO
BARO DPS368 SPI:dps310

# LED Notification
# define AP_NOTIFY_LP5562_ENABLED

# ++++++++++++ TODO: FINISH THIS +++++++++++++ 
